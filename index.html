<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telepromptly</title>
    <style>
        :root {
            --bg: #121212;
            --text: #e0e0e0;
            --ui-bg: #1e1e1e;
            --accent: #4caf50;
            --border: #333;
            --progress-bg: #444;
        }

        body.light-mode {
            --bg: #ffffff;
            --text: #1a1a1a;
            --ui-bg: #f0f0f0;
            --border: #ccc;
            --progress-bg: #ddd;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        #progress-container {
            width: 100%;
            height: 4px;
            background: var(--progress-bg);
            position: fixed;
            top: 0;
            left: 0;
            z-index: 2000;
        }

        #progress-bar {
            height: 100%;
            width: 0%;
            background: var(--accent);
            transition: width 0.1s linear;
        }

        .top-bar {
            display: flex;
            gap: 15px;
            align-items: center;
            justify-content: center;
            padding: 14px 20px 10px 20px;
            background: var(--ui-bg);
            border-bottom: 1px solid var(--border);
            z-index: 1000;
            flex-wrap: wrap;
        }

        #setup-view {
            display: flex;
            flex-direction: column;
            padding: 20px;
            flex-grow: 1;
            gap: 15px;
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
        }

        textarea {
            flex-grow: 1;
            background: var(--ui-bg);
            color: var(--text);
            border: 1px solid var(--border);
            padding: 20px;
            font-size: 1.2rem;
            resize: none;
            outline: none;
        }

        #reading-view {
            display: none;
            height: calc(100vh - 60px);
            overflow-y: scroll;
            scrollbar-width: none;
            padding: 15vh 15% 70vh 15%;
            scroll-behavior: auto;
        }

        #reading-view::-webkit-scrollbar { display: none; }

        #prompt-text {
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
            text-align: center;
            font-weight: 500;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.75rem;
            text-transform: uppercase;
            font-weight: bold;
        }

        button {
            padding: 6px 14px;
            cursor: pointer;
            background: #333;
            color: white;
            border: 1px solid #555;
            font-size: 0.75rem;
            font-weight: bold;
        }

        body.light-mode button { background: #ddd; color: #333; border-color: #bbb; }
        button:hover { background: var(--accent); color: black; border-color: var(--accent); }
        
        .status-pill {
            background: var(--accent);
            color: black;
            padding: 2px 6px;
            font-family: monospace;
            min-width: 32px;
            text-align: center;
        }

        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="progress-container" class="hidden"><div id="progress-bar"></div></div>

    <div id="active-ui" class="top-bar hidden">
        <button onclick="stopPrompter()">‚Üê EXIT</button>
        <div class="control-group">
            <button onclick="toggleScroll()" id="play-pause">PLAY</button>
            <button onclick="restartPrompter()">RESTART</button>
        </div>
        <div class="control-group">
            <span>Speed</span>
            <input type="range" id="speed-slider" min="0" max="100">
            <span class="status-pill" id="speed-val">0</span>
        </div>
        <div class="control-group">
            <span>Size</span>
            <input type="range" id="size-slider" min="20" max="150">
        </div>
        <button onclick="toggleFullscreen()">FULLSCREEN</button>
    </div>

    <div id="setup-view">
        <div class="top-bar" style="border: none; background: transparent;">
            <button onclick="startPrompter()" style="padding: 10px 30px; background: var(--accent); color: black;">START PROMPTER</button>
            <button onclick="toggleTheme()">TOGGLE THEME</button>
        </div>
        <textarea id="script-input" placeholder="Paste your script here..."></textarea>
    </div>

    <div id="reading-view" onclick="toggleScroll()">
        <div id="prompt-text"></div>
    </div>

    <script>
        const elements = {
            setupView: document.getElementById('setup-view'),
            readingView: document.getElementById('reading-view'),
            activeUi: document.getElementById('active-ui'),
            progressContainer: document.getElementById('progress-container'),
            progressBar: document.getElementById('progress-bar'),
            scriptInput: document.getElementById('script-input'),
            promptText: document.getElementById('prompt-text'),
            speedSlider: document.getElementById('speed-slider'),
            sizeSlider: document.getElementById('size-slider'),
            speedVal: document.getElementById('speed-val'),
            playPauseBtn: document.getElementById('play-pause')
        };

        let isScrolling = false;
        let scrollPos = 0;
        let lastTimestamp = 0;

        // Load Persistent Settings
        function initSettings() {
            const savedSpeed = localStorage.getItem('prompterSpeed') || 20;
            const savedSize = localStorage.getItem('prompterSize') || 60;
            
            elements.speedSlider.value = savedSpeed;
            elements.speedVal.innerText = savedSpeed;
            elements.sizeSlider.value = savedSize;
            updateFontSize();
        }

        function saveSettings() {
            localStorage.setItem('prompterSpeed', elements.speedSlider.value);
            localStorage.setItem('prompterSize', elements.sizeSlider.value);
        }

        function startPrompter() {
            const text = elements.scriptInput.value.trim();
            if (!text) return alert("Please enter some text first.");
            
            elements.promptText.innerText = text;
            elements.setupView.classList.add('hidden');
            elements.readingView.style.display = 'block';
            elements.activeUi.classList.remove('hidden');
            elements.progressContainer.classList.remove('hidden');
            
            restartPrompter();
            updateFontSize();
        }

        function stopPrompter() {
            isScrolling = false;
            elements.readingView.style.display = 'none';
            elements.activeUi.classList.add('hidden');
            elements.progressContainer.classList.add('hidden');
            elements.setupView.classList.remove('hidden');
            if (document.fullscreenElement) document.exitFullscreen();
        }

        function restartPrompter() {
            isScrolling = false;
            scrollPos = 0;
            elements.readingView.scrollTop = 0;
            elements.playPauseBtn.innerText = "PLAY";
            updateProgress();
        }

        function toggleScroll() {
            isScrolling = !isScrolling;
            elements.playPauseBtn.innerText = isScrolling ? "PAUSE" : "PLAY";
            if (isScrolling) {
                lastTimestamp = performance.now();
                requestAnimationFrame(scrollLoop);
            }
        }

        function updateProgress() {
            const total = elements.readingView.scrollHeight - elements.readingView.clientHeight;
            const current = elements.readingView.scrollTop;
            const pct = total > 0 ? (current / total) * 100 : 0;
            elements.progressBar.style.width = Math.min(pct, 100) + '%';
        }

        function scrollLoop(timestamp) {
            if (!isScrolling) return;

            const elapsed = timestamp - lastTimestamp;
            lastTimestamp = timestamp;

            // Half-speed logic: divider increased to 80 (was 40)
            const speed = parseFloat(elements.speedSlider.value) / 80; 
            scrollPos += speed * elapsed;
            
            elements.readingView.scrollTop = scrollPos;
            updateProgress();

            if (elements.readingView.scrollTop + elements.readingView.clientHeight >= elements.readingView.scrollHeight - 1) {
                isScrolling = false;
                elements.playPauseBtn.innerText = "PLAY";
            } else {
                requestAnimationFrame(scrollLoop);
            }
        }

        function updateFontSize() {
            elements.promptText.style.fontSize = elements.sizeSlider.value + 'px';
        }

        function toggleTheme() {
            document.body.classList.toggle('light-mode');
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
            } else if (document.exitFullscreen) {
                document.exitFullscreen();
            }
        }

        // Listeners
        elements.speedSlider.oninput = () => {
            elements.speedVal.innerText = elements.speedSlider.value;
            saveSettings();
        };
        elements.sizeSlider.oninput = () => {
            updateFontSize();
            saveSettings();
        };
        elements.readingView.onscroll = updateProgress;

        window.addEventListener('keydown', (e) => {
            if (elements.readingView.style.display === 'block') {
                if (e.key === ' ') { e.preventDefault(); toggleScroll(); }
                if (e.key === 'r' || e.key === 'R') { restartPrompter(); }
                if (e.key === 'ArrowUp') {
                    elements.speedSlider.value = Math.max(0, parseInt(elements.speedSlider.value) - 2);
                    elements.speedVal.innerText = elements.speedSlider.value;
                    saveSettings();
                }
                if (e.key === 'ArrowDown') {
                    elements.speedSlider.value = Math.min(100, parseInt(elements.speedSlider.value) + 2);
                    elements.speedVal.innerText = elements.speedSlider.value;
                    saveSettings();
                }
                if (e.key === 'Escape') stopPrompter();
            }
        });

        // Initialize on load
        initSettings();
    </script>
</body>
</html>